{% extends 'base.html' %}

{% block title %}Upload Questionnaire - Teacher{% endblock %}
{% block header_title %}Upload Questionnaire{% endblock %}
{% block header_subtitle %}Upload materials and auto-extract questions with AI{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">

    <!-- STEP 1: Upload Form (shown by default) -->
    <div id="step1" class="bg-white rounded-xl shadow-lg overflow-hidden">
        <div class="bg-gradient-to-r from-blue-500 to-blue-600 px-6 py-4 flex items-center justify-between">
            <h2 class="text-xl font-bold text-white flex items-center">
                <i class="bi bi-cloud-upload text-2xl mr-3"></i>
                Upload Questionnaire
            </h2>
            <div class="flex items-center gap-3">
                <!-- Step Indicator -->
                <div class="flex items-center gap-2 text-white text-sm">
                    <span class="w-7 h-7 rounded-full bg-white text-blue-600 font-bold flex items-center justify-center text-xs">1</span>
                    <span class="opacity-70">→</span>
                    <span class="w-7 h-7 rounded-full bg-white/20 text-white font-bold flex items-center justify-center text-xs">2</span>
                    <span class="opacity-70">→</span>
                    <span class="w-7 h-7 rounded-full bg-white/20 text-white font-bold flex items-center justify-center text-xs">3</span>
                </div>
                <button type="button" id="guidelinesBtn"
                    class="bg-white/20 hover:bg-white/30 text-white rounded-lg p-2 transition-all"
                    title="View Guidelines">
                    <i class="bi bi-exclamation-circle text-2xl"></i>
                </button>
            </div>
        </div>

        <div class="p-8">
            <form method="post" enctype="multipart/form-data" class="space-y-6" id="uploadForm">
                {% csrf_token %}

                <!-- Title -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="bi bi-card-heading text-blue-500 mr-1"></i> Title *
                    </label>
                    <input type="text" name="title" value="{{ form.title.value|default:'' }}"
                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 transition-colors"
                        placeholder="e.g., Introduction to Programming - Module 1" required>
                    {% if form.title.errors %}
                        <p class="text-red-500 text-sm mt-1"><i class="bi bi-exclamation-circle mr-1"></i>{{ form.title.errors.0 }}</p>
                    {% endif %}
                </div>

                <!-- Description -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="bi bi-card-text text-blue-500 mr-1"></i> Description
                    </label>
                    <textarea name="description" rows="3"
                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 transition-colors resize-none"
                        placeholder="Brief description of this questionnaire...">{{ form.description.value|default:'' }}</textarea>
                </div>

                <!-- Department and Subject -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="id_department" class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="bi bi-building text-blue-500 mr-1"></i> Department *
                        </label>
                        {{ form.department }}
                        {% if form.department.errors %}
                            <p class="text-red-500 text-sm mt-1">{{ form.department.errors.0 }}</p>
                        {% endif %}
                    </div>
                    <div>
                        <label for="id_subject" class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="bi bi-book text-purple-500 mr-1"></i> Subject *
                        </label>
                        {{ form.subject }}
                        {% if form.subject.errors %}
                            <p class="text-red-500 text-sm mt-1">{{ form.subject.errors.0 }}</p>
                        {% endif %}
                        <p class="text-xs text-gray-500 mt-1">Subjects available for the selected department</p>
                    </div>
                </div>

                <!-- File Upload -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="bi bi-file-earmark-arrow-up text-green-500 mr-1"></i> File *
                    </label>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-500 transition-colors" id="dropZone">
                        <i class="bi bi-cloud-upload text-5xl text-gray-400 mb-3 block" id="fileIcon"></i>
                        <p id="fileName" class="text-sm text-gray-500 mb-2">No file selected</p>
                        <input type="file" name="file" id="id_file"
                            class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer"
                            required accept=".pdf,.docx,.doc,.xlsx,.xls,.txt">
                    </div>
                    {% if form.file.errors %}
                        <p class="text-red-500 text-sm mt-1">{{ form.file.errors.0 }}</p>
                    {% endif %}
                    <p class="text-xs text-gray-500 mt-2">
                        <i class="bi bi-info-circle mr-1"></i>
                        Allowed formats: PDF, DOCX, XLSX, XLS, TXT (Max 10MB)
                    </p>
                </div>

                <!-- AI Extraction Options -->
                <div class="bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg p-6 border-2 border-purple-200">
                    <div class="flex items-center mb-5">
                        <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-xl flex items-center justify-center mr-3 shadow">
                            <i class="bi bi-robot text-white text-2xl"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-gray-800">AI-Powered Question Extraction</h3>
                            <p class="text-sm text-gray-600">AI will extract all question types from your content automatically</p>
                        </div>
                    </div>

                    <!-- Question Type Filter (Optional) -->
                    <div class="mb-5">
                        <div class="flex items-center justify-between mb-2">
                            <label class="text-sm font-semibold text-gray-700">
                                <i class="bi bi-funnel text-purple-500 mr-1"></i>
                                Filter Question Types
                                <span class="ml-2 px-2 py-0.5 bg-purple-100 text-purple-700 text-xs rounded-full">Optional</span>
                            </label>
                            <button type="button" id="toggleTypeFilter"
                                class="text-xs text-purple-600 hover:text-purple-800 font-medium underline">
                                Show filters
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mb-3">
                            By default, AI extracts <strong>all question types</strong>. You can optionally filter to specific types only.
                        </p>

                        <!-- Type filter checkboxes (hidden by default) -->
                        <div id="typeFilterContainer" style="display:none;">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                                {% for question_type in form.question_types %}
                                    <label class="flex items-center p-3 bg-white rounded-lg border-2 border-gray-200 hover:border-purple-400 cursor-pointer transition-all">
                                        {{ question_type.tag }}
                                        <span class="ml-3 text-sm font-medium text-gray-700">{{ question_type.choice_label }}</span>
                                    </label>
                                {% endfor %}
                            </div>
                            <p class="text-xs text-gray-500 mt-2">
                                <i class="bi bi-info-circle mr-1"></i>
                                If none selected, all question types will be extracted.
                            </p>
                        </div>
                    </div>

                    <!-- AI Selection Mode -->
                    <div class="border-t border-purple-200 pt-5">
                        <label class="text-sm font-semibold text-gray-700 mb-3 block">
                            <i class="bi bi-stars text-purple-500 mr-1"></i>
                            After Extraction, How Would You Like to Select Questions?
                        </label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">

                            <!-- Manual Selection (Default) -->
                            <label class="flex items-start p-4 bg-white rounded-lg border-2 border-blue-400 cursor-pointer transition-all hover:border-blue-500" id="manualLabel">
                                <input type="radio" name="selection_mode" value="manual" checked
                                    class="mt-1 w-4 h-4 text-blue-600 focus:ring-blue-500"
                                    onchange="toggleSelectionMode(this)">
                                <div class="ml-3">
                                    <span class="text-sm font-semibold text-gray-800 block">
                                        <i class="bi bi-hand-index text-blue-500 mr-1"></i> I'll Choose Manually
                                    </span>
                                    <span class="text-xs text-gray-500 mt-1 block">
                                        Review all extracted questions and pick the ones you want to keep.
                                    </span>
                                    <span class="mt-1 inline-block px-2 py-0.5 bg-blue-100 text-blue-700 text-xs rounded-full font-medium">Default</span>
                                </div>
                            </label>

                            <!-- AI Pick -->
                            <label class="flex items-start p-4 bg-white rounded-lg border-2 border-gray-200 cursor-pointer transition-all hover:border-purple-400" id="aiLabel">
                                <input type="radio" name="selection_mode" value="ai_pick"
                                    class="mt-1 w-4 h-4 text-purple-600 focus:ring-purple-500"
                                    onchange="toggleSelectionMode(this)">
                                <div class="ml-3">
                                    <span class="text-sm font-semibold text-gray-800 block">
                                        <i class="bi bi-magic text-purple-500 mr-1"></i> Let AI Pick for Me
                                    </span>
                                    <span class="text-xs text-gray-500 mt-1 block">
                                        AI will randomly select the best questions for you.
                                    </span>
                                    <span class="mt-1 inline-block px-2 py-0.5 bg-purple-100 text-purple-700 text-xs rounded-full font-medium">Optional</span>
                                </div>
                            </label>
                        </div>

                        <!-- AI Pick Options (hidden by default) -->
                        <div id="aiPickOptions" style="display:none;" class="mt-4 bg-purple-50 rounded-lg p-4 border border-purple-200">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="bi bi-hash text-purple-500 mr-1"></i>
                                How many questions should AI pick?
                            </label>
                            <div class="flex items-center gap-4">
                                <input type="number" name="ai_pick_count" id="ai_pick_count"
                                    value="10" min="1" max="50"
                                    class="w-32 px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-purple-500 text-center font-bold text-lg">
                                <span class="text-sm text-gray-600">questions (max 50)</span>
                            </div>
                            <p class="text-xs text-gray-500 mt-2">
                                <i class="bi bi-shuffle text-purple-500 mr-1"></i>
                                AI will pick a balanced mix across difficulty levels and question types.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Hidden field to pass selection mode -->
                <input type="hidden" name="auto_extract" value="true">

                {% if form.non_field_errors %}
                    <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded">
                        {% for error in form.non_field_errors %}
                            <p class="text-red-700 text-sm">{{ error }}</p>
                        {% endfor %}
                    </div>
                {% endif %}

                <!-- Submit Button -->
                <div class="flex space-x-3 pt-4">
                    <button type="submit" id="submitBtn"
                        class="flex-1 bg-gradient-to-r from-blue-500 to-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:from-blue-600 hover:to-blue-700 transition-all shadow-lg flex items-center justify-center">
                        <i class="bi bi-upload mr-2"></i> Upload & Extract Questions
                    </button>
                    <a href="{% url 'accounts:teacher_dashboard' %}"
                        class="flex-1 bg-gray-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-600 transition-all text-center flex items-center justify-center">
                        <i class="bi bi-x-circle mr-2"></i> Cancel
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" style="display:none;" class="fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center">
    <div class="bg-white rounded-2xl p-10 max-w-sm w-full mx-4 text-center shadow-2xl">
        <div class="relative inline-block mb-6">
            <div class="w-20 h-20 border-4 border-purple-200 rounded-full animate-spin border-t-purple-600"></div>
            <div class="absolute inset-0 flex items-center justify-center">
                <i class="bi bi-robot text-purple-600 text-2xl"></i>
            </div>
        </div>
        <h3 class="text-xl font-bold text-gray-800 mb-2">AI is Working...</h3>
        <p class="text-gray-500 text-sm mb-4">Analyzing your file and extracting questions. This may take a moment.</p>
        <div class="flex items-center justify-center gap-1">
            <div class="w-2 h-2 bg-purple-500 rounded-full animate-bounce"></div>
            <div class="w-2 h-2 bg-purple-500 rounded-full animate-bounce" style="animation-delay:0.15s"></div>
            <div class="w-2 h-2 bg-purple-500 rounded-full animate-bounce" style="animation-delay:0.3s"></div>
        </div>
    </div>
</div>

<!-- Guidelines Modal -->
<div id="guidelinesModal" style="display:none;" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full">
        <div class="bg-gradient-to-r from-blue-500 to-indigo-600 px-6 py-4 flex items-center justify-between rounded-t-xl">
            <div class="flex items-center">
                <div class="w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center mr-3">
                    <i class="bi bi-info-circle text-white text-xl"></i>
                </div>
                <h3 class="text-lg font-bold text-white">Upload Guidelines</h3>
            </div>
            <button type="button" id="closeModal" class="text-white hover:bg-white/20 rounded-lg p-1 transition-colors">
                <i class="bi bi-x-lg text-xl"></i>
            </button>
        </div>
        <div class="p-6">
            <ul class="space-y-3 text-sm text-gray-700">
                <li class="flex items-start">
                    <i class="bi bi-check-circle-fill text-green-500 mr-2 mt-0.5 flex-shrink-0"></i>
                    <span><strong>Step 1:</strong> Upload your educational material (PDF, DOCX, etc.)</span>
                </li>
                <li class="flex items-start">
                    <i class="bi bi-check-circle-fill text-green-500 mr-2 mt-0.5 flex-shrink-0"></i>
                    <span><strong>Step 2:</strong> AI extracts questions - review and select the ones you want</span>
                </li>
                <li class="flex items-start">
                    <i class="bi bi-check-circle-fill text-green-500 mr-2 mt-0.5 flex-shrink-0"></i>
                    <span><strong>Step 3:</strong> Save & download your final questionnaire file</span>
                </li>
                <li class="flex items-start">
                    <i class="bi bi-check-circle-fill text-green-500 mr-2 mt-0.5 flex-shrink-0"></i>
                    <span>Select multiple question types for variety</span>
                </li>
                <li class="flex items-start">
                    <i class="bi bi-check-circle-fill text-green-500 mr-2 mt-0.5 flex-shrink-0"></i>
                    <span>Maximum file size is 10MB</span>
                </li>
            </ul>
        </div>
        <div class="px-6 pb-6">
            <button type="button" id="closeModalBtn"
                class="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:from-blue-600 hover:to-blue-700 transition-all">
                Got it!
            </button>
        </div>
    </div>
</div>

<script>
(function() {
    // Department/Subject AJAX
    const deptSelect = document.getElementById('id_department');
    const subjSelect = document.getElementById('id_subject');
    if (deptSelect && subjSelect) {
        deptSelect.className = 'w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 transition-colors';
        subjSelect.className = 'w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-purple-500 transition-colors';
        deptSelect.addEventListener('change', function() {
            const id = this.value;
            if (id) {
                fetch(`/questionnaires/get-subjects/?department=${id}`)
                    .then(r => r.json())
                    .then(data => {
                        subjSelect.innerHTML = '<option value="">Select Subject</option>';
                        data.subjects.forEach(s => {
                            const o = document.createElement('option');
                            o.value = s.id;
                            o.textContent = `${s.code} - ${s.name}`;
                            subjSelect.appendChild(o);
                        });
                    });
            } else {
                subjSelect.innerHTML = '<option value="">Select Subject</option>';
            }
        });
    }

    // File name preview
    const fileInput = document.getElementById('id_file');
    const fileNameEl = document.getElementById('fileName');
    if (fileInput && fileNameEl) {
        fileInput.addEventListener('change', function() {
            if (this.files.length > 0) {
                fileNameEl.textContent = this.files[0].name;
                fileNameEl.className = 'text-sm text-blue-600 font-medium mb-2';
                document.getElementById('fileIcon').className = 'bi bi-file-earmark-check text-5xl text-green-500 mb-3 block';
            } else {
                fileNameEl.textContent = 'No file selected';
                fileNameEl.className = 'text-sm text-gray-500 mb-2';
                document.getElementById('fileIcon').className = 'bi bi-cloud-upload text-5xl text-gray-400 mb-3 block';
            }
        });
    }

    // Toggle type filter visibility
    const toggleBtn = document.getElementById('toggleTypeFilter');
    const typeFilterContainer = document.getElementById('typeFilterContainer');
    if (toggleBtn && typeFilterContainer) {
        toggleBtn.addEventListener('click', function() {
            const isHidden = typeFilterContainer.style.display === 'none';
            typeFilterContainer.style.display = isHidden ? 'block' : 'none';
            this.textContent = isHidden ? 'Hide filters' : 'Show filters';
        });
    }

    // Show loading overlay on submit
    const form = document.getElementById('uploadForm');
    const loading = document.getElementById('loadingOverlay');
    const submitBtn = document.getElementById('submitBtn');
    if (form && loading) {
        form.addEventListener('submit', function() {
            const autoEx = document.getElementById('id_auto_extract');
            if (autoEx && autoEx.checked) {
                loading.style.display = 'flex';
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="bi bi-hourglass-split mr-2"></i> Extracting Questions...';
            }
        });
    }

    // Guidelines Modal
    const guidelinesBtn = document.getElementById('guidelinesBtn');
    const modal = document.getElementById('guidelinesModal');
    const closeModal = document.getElementById('closeModal');
    const closeModalBtn = document.getElementById('closeModalBtn');
    function openModal() { modal.style.display = 'flex'; document.body.style.overflow = 'hidden'; }
    function closeM() { modal.style.display = 'none'; document.body.style.overflow = 'auto'; }
    if (guidelinesBtn) guidelinesBtn.addEventListener('click', e => { e.preventDefault(); openModal(); });
    if (closeModal) closeModal.addEventListener('click', closeM);
    if (closeModalBtn) closeModalBtn.addEventListener('click', closeM);
    if (modal) modal.addEventListener('click', e => { if (e.target === modal) closeM(); });
    document.addEventListener('keydown', e => { if (e.key === 'Escape' && modal.style.display === 'flex') closeM(); });
})();

// Selection mode toggle (outside IIFE so it's accessible by inline onchange)
function toggleSelectionMode(radio) {
    const aiOptions = document.getElementById('aiPickOptions');
    const manualLabel = document.getElementById('manualLabel');
    const aiLabel = document.getElementById('aiLabel');

    if (radio.value === 'ai_pick') {
        aiOptions.style.display = 'block';
        aiLabel.className = aiLabel.className.replace('border-gray-200', 'border-purple-400');
        manualLabel.className = manualLabel.className.replace('border-blue-400', 'border-gray-200');
    } else {
        aiOptions.style.display = 'none';
        manualLabel.className = manualLabel.className.replace('border-gray-200', 'border-blue-400');
        aiLabel.className = aiLabel.className.replace('border-purple-400', 'border-gray-200');
    }
}
</script>
{% endblock %}