{% extends 'base.html' %}

{% block title %}My Uploads - Teacher{% endblock %}
{% block header_title %}My Uploads{% endblock %}
{% block header_subtitle %}Manage your uploaded questionnaires{% endblock %}

{% block content %}
<!-- Header Actions -->
<div class="flex justify-between items-center mb-6">
    <div class="flex items-center">
        <i class="bi bi-file-person text-3xl text-blue-500 mr-3"></i>
        <div>
            <h2 class="text-2xl font-bold text-gray-800">Your Questionnaires</h2>
            <p class="text-sm text-gray-500">{{ page_obj.paginator.count }} total upload{{ page_obj.paginator.count|pluralize }}</p>
        </div>
    </div>
    <a href="{% url 'questionnaires:upload_questionnaire' %}" class="bg-gradient-to-r from-blue-500 to-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:from-blue-600 hover:to-blue-700 transition-all transform hover:scale-105 shadow-lg hover:shadow-xl flex items-center">
        <i class="bi bi-upload text-xl mr-2"></i>
        Upload New
    </a>
</div>

<!-- Search Bar -->
<div class="bg-white rounded-xl shadow-lg p-4 mb-8">
    <form method="get" class="flex gap-3">
        <div class="flex-1">
            <input type="text" name="search" value="{{ search_query }}"
                placeholder="Search your uploads..."
                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 transition-colors">
        </div>
        <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold px-6 py-3 rounded-lg transition-all shadow-lg">
            <i class="bi bi-search mr-2"></i> Search
        </button>
    </form>
</div>

<!-- Questionnaires Grid -->
{% if page_obj %}
<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 mb-8">
    {% for quest in page_obj %}
    <div class="bg-white rounded-xl shadow-lg hover:shadow-2xl transition-all transform hover:-translate-y-1">

        <!-- Card Header -->
        <div class="bg-gradient-to-r from-blue-500 to-indigo-600 px-5 py-4 rounded-t-xl">
            <h3 class="text-white font-bold text-lg line-clamp-2">{{ quest.title }}</h3>
            {% if quest.is_extracted %}
                <span class="inline-block mt-2 px-3 py-1 bg-green-100 text-green-700 text-xs font-semibold rounded-full">
                    <i class="bi bi-check-circle mr-1"></i> Questions Extracted
                </span>
            {% elif quest.extraction_status == 'processing' %}
                <span class="inline-block mt-2 px-3 py-1 bg-yellow-100 text-yellow-700 text-xs font-semibold rounded-full">
                    <i class="bi bi-hourglass-split mr-1"></i> Processing...
                </span>
            {% elif quest.extraction_status == 'failed' %}
                <span class="inline-block mt-2 px-3 py-1 bg-red-100 text-red-700 text-xs font-semibold rounded-full">
                    <i class="bi bi-x-circle mr-1"></i> Extraction Failed
                </span>
            {% endif %}
        </div>

        <!-- Card Body -->
        <div class="p-5">
            <p class="text-gray-600 text-sm mb-4 line-clamp-3">
                {{ quest.description|default:"No description provided"|truncatewords:20 }}
            </p>
            <div class="space-y-2.5">
                <div class="flex items-center text-sm">
                    <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                        <i class="bi bi-building text-blue-600"></i>
                    </div>
                    <div>
                        <span class="text-gray-500 text-xs">Department</span>
                        <p class="font-semibold text-gray-800">{{ quest.department.code }}</p>
                    </div>
                </div>
                <div class="flex items-center text-sm">
                    <div class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center mr-3">
                        <i class="bi bi-book text-purple-600"></i>
                    </div>
                    <div>
                        <span class="text-gray-500 text-xs">Subject</span>
                        <p class="font-semibold text-gray-800">{{ quest.subject.code }}</p>
                    </div>
                </div>
                <div class="flex items-center justify-between text-sm pt-2 border-t border-gray-200">
                    <div class="flex items-center">
                        <i class="bi bi-file-earmark text-orange-500 mr-2"></i>
                        <span class="text-gray-600">{{ quest.file_type|upper }}</span>
                    </div>
                    <span class="text-gray-600">{{ quest.get_file_size_display }}</span>
                </div>
                <div class="flex items-center text-sm">
                    <i class="bi bi-calendar text-gray-400 mr-2"></i>
                    <span class="text-gray-600">{{ quest.uploaded_at|date:"M d, Y" }}</span>
                </div>
                {% if quest.is_extracted %}
                <div class="flex items-center text-sm bg-green-50 p-2 rounded-lg">
                    <i class="bi bi-check2-square text-green-600 mr-2"></i>
                    <span class="text-green-700 font-semibold">
                        {{ quest.approved_questions }} of {{ quest.total_questions }} approved
                    </span>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Card Footer -->
        <div class="bg-gray-50 px-5 py-4 rounded-b-xl">

            <!-- Download Button — uses fixed-position dropdown via JS -->
            <div class="mb-2">
                <button
                    type="button"
                    data-quest-id="{{ quest.pk }}"
                    data-file-type="{{ quest.file_type|upper }}"
                    data-is-extracted="{{ quest.is_extracted|yesno:'true,false' }}"
                    data-url-original="{% url 'questionnaires:download_questionnaire' quest.pk %}?type=original"
                    data-url-docx="{% url 'questionnaires:download_questionnaire' quest.pk %}?type=generated&format=docx"
                    data-url-pdf="{% url 'questionnaires:download_questionnaire' quest.pk %}?type=generated&format=pdf"
                    class="download-btn w-full bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-semibold py-2.5 px-4 rounded-lg transition-all flex items-center justify-center shadow-lg"
                >
                    <i class="bi bi-download mr-2"></i> Download
                    <i class="bi bi-chevron-down ml-auto"></i>
                </button>
            </div>

            <!-- Action Buttons -->
            <div class="flex items-center space-x-2">
                {% if quest.is_extracted %}
                <a href="{% url 'questionnaires:review_extracted' quest.pk %}"
                    class="flex-1 bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-3 rounded-lg transition-all text-center text-sm">
                    <i class="bi bi-list-check mr-1"></i> Review
                </a>
                {% endif %}
                <a href="{% url 'questionnaires:edit_questionnaire' quest.pk %}"
                    class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-3 rounded-lg transition-all" title="Edit">
                    <i class="bi bi-pencil-square"></i>
                </a>
                <a href="{% url 'questionnaires:delete_questionnaire' quest.pk %}"
                    class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-3 rounded-lg transition-all" title="Delete">
                    <i class="bi bi-trash3"></i>
                </a>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

{% else %}
<!-- Empty State -->
<div class="bg-white rounded-xl shadow-lg p-16 text-center">
    <div class="w-32 h-32 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6">
        <i class="bi bi-inbox text-6xl text-gray-400"></i>
    </div>
    <h3 class="text-2xl font-bold text-gray-700 mb-3">No Uploads Yet</h3>
    <p class="text-gray-500 mb-6">Start by uploading your first questionnaire</p>
    <a href="{% url 'questionnaires:upload_questionnaire' %}"
        class="inline-flex items-center px-6 py-3 bg-blue-500 text-white font-semibold rounded-lg hover:bg-blue-600 transition-colors">
        <i class="bi bi-upload mr-2"></i> Upload Questionnaire
    </a>
</div>
{% endif %}

<!-- Pagination -->
{% if page_obj.has_other_pages %}
<div class="flex justify-center">
    <nav class="flex items-center space-x-2">
        {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}&search={{ search_query }}"
                class="px-4 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-colors font-semibold text-gray-700">
                <i class="bi bi-chevron-left"></i> Previous
            </a>
        {% endif %}
        {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
                <span class="px-4 py-2 bg-blue-500 text-white font-bold rounded-lg">{{ num }}</span>
            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                <a href="?page={{ num }}&search={{ search_query }}"
                    class="px-4 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-colors font-semibold text-gray-700">
                    {{ num }}
                </a>
            {% endif %}
        {% endfor %}
        {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}&search={{ search_query }}"
                class="px-4 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-colors font-semibold text-gray-700">
                Next <i class="bi bi-chevron-right"></i>
            </a>
        {% endif %}
    </nav>
</div>
{% endif %}

<!-- =====================================================================
     FIXED-POSITION DROPDOWN PORTAL
     Renders outside the card grid so it's NEVER covered by other cards
     ===================================================================== -->
<div id="download-dropdown-portal"
    style="display:none; position:fixed; z-index:99999; min-width:220px;"
    class="bg-white rounded-lg shadow-2xl border-2 border-gray-200">
</div>

<!-- =====================================================================
     {% comment %} STYLES + SCRIPT — inside {% block content %} so it always renders {% endcomment %}
     ===================================================================== -->
<style>
.line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
.line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
</style>

<script>
(function () {
    var portal = document.getElementById('download-dropdown-portal');
    var activeBtn = null;

    function buildMenuHTML(btn) {
        var fileType   = btn.getAttribute('data-file-type');
        var isExtracted = btn.getAttribute('data-is-extracted') === 'true';
        var urlOriginal = btn.getAttribute('data-url-original');
        var urlDocx     = btn.getAttribute('data-url-docx');
        var urlPdf      = btn.getAttribute('data-url-pdf');

        var html = '<a href="' + urlOriginal + '" class="block px-4 py-3 hover:bg-gray-100 transition-colors rounded-t-lg">' +
            '<div class="flex items-center">' +
            '<i class="bi bi-file-earmark text-blue-500 text-lg mr-3"></i>' +
            '<div><span class="font-semibold text-gray-800 block">Original File</span>' +
            '<span class="text-xs text-gray-500">' + fileType + ' format</span></div>' +
            '</div></a>';

        if (isExtracted) {
            html += '<div class="border-t border-gray-200"></div>' +
                '<div class="px-4 py-2 bg-purple-50">' +
                '<span class="text-xs font-bold text-purple-700"><i class="bi bi-stars mr-1"></i> BISU Official Format</span>' +
                '</div>' +
                '<a href="' + urlDocx + '" class="block px-4 py-3 hover:bg-gray-100 transition-colors">' +
                '<div class="flex items-center">' +
                '<i class="bi bi-file-word text-blue-600 text-lg mr-3"></i>' +
                '<div><span class="font-semibold text-gray-800 block">Word Document</span>' +
                '<span class="text-xs text-gray-500">Professional BISU format (DOCX)</span></div>' +
                '</div></a>' +
                '<a href="' + urlPdf + '" class="block px-4 py-3 hover:bg-gray-100 transition-colors rounded-b-lg">' +
                '<div class="flex items-center">' +
                '<i class="bi bi-file-pdf text-red-600 text-lg mr-3"></i>' +
                '<div><span class="font-semibold text-gray-800 block">PDF Document</span>' +
                '<span class="text-xs text-gray-500">Ready-to-print BISU format (PDF)</span></div>' +
                '</div></a>';
        }

        return html;
    }

    function openDropdown(btn) {
        var rect = btn.getBoundingClientRect();

        // Build content first so we can measure its height
        portal.innerHTML = buildMenuHTML(btn);
        portal.style.display = 'block';
        portal.style.left = rect.left + 'px';
        portal.style.width = rect.width + 'px';
        portal.style.top = '-9999px'; // render off-screen to measure
        portal.style.bottom = '';

        var menuHeight = portal.offsetHeight;
        var spaceBelow = window.innerHeight - rect.bottom;
        var spaceAbove = rect.top;

        if (spaceBelow >= menuHeight + 8) {
            // Enough space below — open downward
            portal.style.top = (rect.bottom + 4) + 'px';
        } else if (spaceAbove >= menuHeight + 8) {
            // Not enough space below but enough above — open upward
            portal.style.top = (rect.top - menuHeight - 4) + 'px';
        } else {
            // Not enough space either way — pick the bigger side and scroll within
            if (spaceBelow >= spaceAbove) {
                portal.style.top = (rect.bottom + 4) + 'px';
                portal.style.maxHeight = (spaceBelow - 8) + 'px';
                portal.style.overflowY = 'auto';
            } else {
                portal.style.top = '8px';
                portal.style.maxHeight = (spaceAbove - 8) + 'px';
                portal.style.overflowY = 'auto';
            }
        }

        activeBtn = btn;
    }

    function closeDropdown() {
        portal.style.display = 'none';
        portal.style.maxHeight = '';
        portal.style.overflowY = '';
        portal.innerHTML = '';
        activeBtn = null;
    }

    // Attach click to all download buttons
    document.querySelectorAll('.download-btn').forEach(function (btn) {
        btn.addEventListener('click', function (e) {
            e.stopPropagation();
            if (activeBtn === btn) {
                closeDropdown();
            } else {
                openDropdown(btn);
            }
        });
    });

    // Close when clicking outside
    document.addEventListener('click', function (e) {
        if (!portal.contains(e.target)) {
            closeDropdown();
        }
    });

    // Reposition on scroll/resize
    window.addEventListener('scroll', closeDropdown, true);
    window.addEventListener('resize', closeDropdown);
})();
</script>

{% endblock %}