{% extends 'base.html' %}

{% block title %}Browse Questionnaires - Teacher{% endblock %}
{% block header_title %}Browse Questionnaires{% endblock %}
{% block header_subtitle %}Discover and download questionnaires from your colleagues{% endblock %}

{% block content %}

<!-- Filter Card -->
<div class="bg-white rounded-xl shadow-lg p-6 mb-8">
    <form method="get" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">
                <i class="bi bi-book text-purple-500 mr-1"></i> Subject
            </label>
            <select name="subject"
                class="w-full px-4 py-2.5 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-purple-500 transition-colors">
                <option value="">All Subjects</option>
                {% for sub in subjects %}
                    <option value="{{ sub.id }}" {% if selected_subject == sub.id|stringformat:"s" %}selected{% endif %}>
                        {{ sub.code }} - {{ sub.name }}
                    </option>
                {% endfor %}
            </select>
        </div>
        <div class="lg:col-span-2">
            <label class="block text-sm font-semibold text-gray-700 mb-2">
                <i class="bi bi-search text-green-500 mr-1"></i> Search
            </label>
            <input type="text" name="search" value="{{ search_query }}"
                placeholder="Search questionnaires..."
                class="w-full px-4 py-2.5 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-green-500 transition-colors">
        </div>
        <div class="flex items-end">
            <button type="submit"
                class="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white font-bold py-2.5 px-6 rounded-lg hover:from-blue-600 hover:to-blue-700 transition-all shadow-lg flex items-center justify-center">
                <i class="bi bi-funnel text-lg mr-2"></i> Filter
            </button>
        </div>
    </form>
</div>

<!-- Questionnaires Grid -->
{% if page_obj %}
<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 mb-8">
    {% for quest in page_obj %}
    <div class="bg-white rounded-xl shadow-lg hover:shadow-2xl transition-all transform hover:-translate-y-1">

        <!-- Card Header -->
        <div class="bg-gradient-to-r from-purple-500 to-pink-600 px-5 py-4 rounded-t-xl">
            <h3 class="text-white font-bold text-lg line-clamp-2">{{ quest.title }}</h3>
            {% if quest.is_extracted %}
                <span class="inline-block mt-2 px-3 py-1 bg-white/20 text-white text-xs font-semibold rounded-full">
                    <i class="bi bi-check-circle mr-1"></i> {{ quest.extracted_questions.count }} Questions Available
                </span>
            {% endif %}
        </div>

        <!-- Card Body -->
        <div class="p-5">
            <p class="text-gray-600 text-sm mb-4 line-clamp-3">
                {{ quest.description|default:"No description provided"|truncatewords:20 }}
            </p>
            <div class="space-y-2.5">
                <div class="flex items-center text-sm">
                    <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                        <i class="bi bi-building text-blue-600"></i>
                    </div>
                    <div>
                        <span class="text-gray-500 text-xs">Department</span>
                        <p class="font-semibold text-gray-800">{{ quest.department.code }}</p>
                    </div>
                </div>
                <div class="flex items-center text-sm">
                    <div class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center mr-3">
                        <i class="bi bi-book text-purple-600"></i>
                    </div>
                    <div>
                        <span class="text-gray-500 text-xs">Subject</span>
                        <p class="font-semibold text-gray-800">{{ quest.subject.code }}</p>
                    </div>
                </div>
                <div class="flex items-center text-sm">
                    <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center mr-3">
                        <i class="bi bi-person text-green-600"></i>
                    </div>
                    <div>
                        <span class="text-gray-500 text-xs">Uploaded by</span>
                        <p class="font-semibold text-gray-800">{{ quest.uploader.user.get_full_name }}</p>
                    </div>
                </div>
                <div class="flex items-center justify-between text-sm pt-2 border-t border-gray-200">
                    <div class="flex items-center">
                        <i class="bi bi-file-earmark text-orange-500 mr-2"></i>
                        <span class="text-gray-600">{{ quest.file_type|upper }}</span>
                    </div>
                    <span class="text-gray-600">{{ quest.get_file_size_display }}</span>
                </div>
                <div class="flex items-center text-sm">
                    <i class="bi bi-calendar text-gray-400 mr-2"></i>
                    <span class="text-gray-600">{{ quest.uploaded_at|date:"M d, Y" }}</span>
                </div>
            </div>
        </div>

        <!-- Card Footer -->
        <div class="bg-gray-50 px-5 py-4 rounded-b-xl">
            <!-- Download dropdown -->
            <div class="mb-2">
                <button type="button"
                    data-quest-id="{{ quest.pk }}"
                    data-file-type="{{ quest.file_type|upper }}"
                    data-is-extracted="{{ quest.is_extracted|yesno:'true,false' }}"
                    data-url-original="{% url 'questionnaires:download_questionnaire' quest.pk %}?type=original"
                    data-url-docx="{% url 'questionnaires:download_questionnaire' quest.pk %}?type=generated&format=docx"
                    data-url-pdf="{% url 'questionnaires:download_questionnaire' quest.pk %}?type=generated&format=pdf"
                    class="download-btn w-full bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-semibold py-2.5 px-4 rounded-lg transition-all flex items-center justify-center shadow-lg">
                    <i class="bi bi-download mr-2"></i> Download
                    <i class="bi bi-chevron-down ml-auto"></i>
                </button>
            </div>

            <!-- Review button (only if questions extracted) -->
            {% if quest.is_extracted %}
            <button type="button"
                data-quest-id="{{ quest.pk }}"
                data-quest-title="{{ quest.title }}"
                class="review-btn w-full bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg transition-all flex items-center justify-center text-sm">
                <i class="bi bi-list-check mr-2"></i> Review Questions
            </button>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>

{% else %}
<div class="bg-white rounded-xl shadow-lg p-16 text-center">
    <div class="w-32 h-32 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6">
        <i class="bi bi-inbox text-6xl text-gray-400"></i>
    </div>
    <h3 class="text-2xl font-bold text-gray-700 mb-3">No Questionnaires Found</h3>
    <p class="text-gray-500 mb-6">Try adjusting your filters or search query</p>
    <a href="{% url 'questionnaires:browse_questionnaires' %}"
        class="inline-flex items-center px-6 py-3 bg-blue-500 text-white font-semibold rounded-lg hover:bg-blue-600 transition-colors">
        <i class="bi bi-arrow-clockwise mr-2"></i> Reset Filters
    </a>
</div>
{% endif %}

<!-- Pagination -->
{% if page_obj.has_other_pages %}
<div class="flex justify-center">
    <nav class="flex items-center space-x-2">
        {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}{% if selected_subject and selected_subject != 'None' %}&subject={{ selected_subject }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}"
                class="px-4 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-colors font-semibold text-gray-700">
                <i class="bi bi-chevron-left"></i> Previous
            </a>
        {% endif %}
        {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
                <span class="px-4 py-2 bg-blue-500 text-white font-bold rounded-lg">{{ num }}</span>
            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                <a href="?page={{ num }}{% if selected_subject and selected_subject != 'None' %}&subject={{ selected_subject }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}"
                    class="px-4 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-colors font-semibold text-gray-700">
                    {{ num }}
                </a>
            {% endif %}
        {% endfor %}
        {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}{% if selected_subject and selected_subject != 'None' %}&subject={{ selected_subject }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}"
                class="px-4 py-2 bg-white border-2 border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-colors font-semibold text-gray-700">
                Next <i class="bi bi-chevron-right"></i>
            </a>
        {% endif %}
    </nav>
</div>
{% endif %}

<!-- DOWNLOAD DROPDOWN PORTAL -->
<div id="download-dropdown-portal"
    style="display:none; position:fixed; z-index:99999; min-width:220px;"
    class="bg-white rounded-lg shadow-2xl border-2 border-gray-200">
</div>

<!-- REVIEW MODAL -->
<div id="reviewModal" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden items-start justify-center p-4 overflow-y-auto">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl my-8">

        <!-- Modal Header -->
        <div class="bg-gradient-to-r from-purple-500 to-pink-600 px-6 py-5 rounded-t-2xl flex items-center justify-between">
            <div>
                <h2 class="text-xl font-bold text-white" id="modalTitle">Review Questions</h2>
                <p class="text-white/80 text-sm mt-0.5" id="modalSubtitle">Select questions to include in your download</p>
            </div>
            <button type="button" id="closeReviewModal"
                class="text-white hover:bg-white/20 rounded-lg p-2 transition-colors">
                <i class="bi bi-x-lg text-xl"></i>
            </button>
        </div>

        <!-- Modal Stats Bar -->
        <div class="grid grid-cols-3 gap-0 border-b border-gray-200">
            <div class="p-4 text-center border-r border-gray-200">
                <div class="text-2xl font-bold text-blue-600" id="modalTotalCount">0</div>
                <div class="text-xs text-gray-500">Total Questions</div>
            </div>
            <div class="p-4 text-center border-r border-gray-200">
                <div class="text-2xl font-bold text-green-600" id="modalSelectedCount">0</div>
                <div class="text-xs text-gray-500">Selected</div>
            </div>
            <div class="p-4 text-center">
                <div class="text-2xl font-bold text-orange-600" id="modalPointsCount">0</div>
                <div class="text-xs text-gray-500">Total Points</div>
            </div>
        </div>

        <!-- Modal Filter & Actions Bar -->
        <div class="px-6 py-4 bg-gray-50 border-b border-gray-200 flex flex-wrap items-center gap-3">
            <select id="modalFilterType"
                class="px-3 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-purple-500 text-sm">
                <option value="all">All Types</option>
            </select>
            <select id="modalFilterDiff"
                class="px-3 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-purple-500 text-sm">
                <option value="all">All Difficulties</option>
                <option value="easy">Easy</option>
                <option value="medium">Medium</option>
                <option value="hard">Hard</option>
            </select>
            <button type="button" id="modalSelectAll"
                class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 text-sm font-semibold">
                <i class="bi bi-check-all mr-1"></i> Select All
            </button>
            <button type="button" id="modalDeselectAll"
                class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 text-sm font-semibold">
                <i class="bi bi-x-lg mr-1"></i> Deselect All
            </button>
        </div>

        <!-- Modal Questions List -->
        <div id="modalQuestionsList" class="p-6 space-y-3 max-h-[50vh] overflow-y-auto">
            <div class="flex items-center justify-center py-10 text-gray-400">
                <div class="text-center">
                    <div class="w-10 h-10 border-4 border-purple-200 border-t-purple-500 rounded-full mx-auto mb-3" id="modalSpinner" style="animation: spin 1s linear infinite;"></div>
                    <p>Loading questions...</p>
                </div>
            </div>
        </div>

        <!-- Modal Footer -->
        <div class="px-6 py-5 bg-gray-50 rounded-b-2xl border-t border-gray-200">
            <p id="modalSelectionLabel" class="text-xs text-gray-500 mb-3 font-medium">
                All questions selected for download
            </p>
            <div class="flex flex-wrap items-center gap-3">
                <span class="text-sm font-semibold text-gray-700">Download selected as:</span>
                <a id="modalDownloadDocx" href="#"
                    class="flex items-center gap-2 px-4 py-2.5 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-semibold rounded-lg transition-all shadow text-sm">
                    <i class="bi bi-file-word"></i> BISU DOCX
                </a>
                <a id="modalDownloadPdf" href="#"
                    class="flex items-center gap-2 px-4 py-2.5 bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-semibold rounded-lg transition-all shadow text-sm">
                    <i class="bi bi-file-pdf"></i> BISU PDF
                </a>
                <a id="modalDownloadOriginal" href="#"
                    class="flex items-center gap-2 px-4 py-2.5 bg-gray-500 hover:bg-gray-600 text-white font-semibold rounded-lg transition-all shadow text-sm">
                    <i class="bi bi-file-earmark"></i> Original File
                </a>
                <button type="button" id="closeReviewModalFooter"
                    class="ml-auto px-4 py-2.5 bg-white border-2 border-gray-300 hover:border-gray-400 text-gray-700 font-semibold rounded-lg transition-all text-sm">
                    <i class="bi bi-x mr-1"></i> Close
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
.line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
@keyframes spin {
    to { transform: rotate(360deg); }
}
</style>

<script>
(function () {

    // ================================================================
    // DOWNLOAD DROPDOWN PORTAL
    // ================================================================
    var portal = document.getElementById('download-dropdown-portal');
    var activeBtn = null;

    function buildMenuHTML(btn) {
        var fileType    = btn.getAttribute('data-file-type');
        var isExtracted = btn.getAttribute('data-is-extracted') === 'true';
        var urlOriginal = btn.getAttribute('data-url-original');
        var urlDocx     = btn.getAttribute('data-url-docx');
        var urlPdf      = btn.getAttribute('data-url-pdf');

        var html = '<a href="' + urlOriginal + '" class="block px-4 py-3 hover:bg-gray-100 transition-colors rounded-t-lg">' +
            '<div class="flex items-center">' +
            '<i class="bi bi-file-earmark text-blue-500 text-lg mr-3"></i>' +
            '<div><span class="font-semibold text-gray-800 block">Original File</span>' +
            '<span class="text-xs text-gray-500">' + fileType + ' format</span></div>' +
            '</div></a>';

        if (isExtracted) {
            html += '<div class="border-t border-gray-200"></div>' +
                '<div class="px-4 py-2 bg-purple-50">' +
                '<span class="text-xs font-bold text-purple-700"><i class="bi bi-stars mr-1"></i> BISU Official Format</span>' +
                '</div>' +
                '<a href="' + urlDocx + '" class="block px-4 py-3 hover:bg-gray-100 transition-colors">' +
                '<div class="flex items-center">' +
                '<i class="bi bi-file-word text-blue-600 text-lg mr-3"></i>' +
                '<div><span class="font-semibold text-gray-800 block">Word Document</span>' +
                '<span class="text-xs text-gray-500">Professional BISU format (DOCX)</span></div>' +
                '</div></a>' +
                '<a href="' + urlPdf + '" class="block px-4 py-3 hover:bg-gray-100 transition-colors rounded-b-lg">' +
                '<div class="flex items-center">' +
                '<i class="bi bi-file-pdf text-red-600 text-lg mr-3"></i>' +
                '<div><span class="font-semibold text-gray-800 block">PDF Document</span>' +
                '<span class="text-xs text-gray-500">Ready-to-print BISU format (PDF)</span></div>' +
                '</div></a>';
        }
        return html;
    }

    function openDropdown(btn) {
        var rect = btn.getBoundingClientRect();
        portal.innerHTML = buildMenuHTML(btn);
        portal.style.display = 'block';
        portal.style.left = rect.left + 'px';
        portal.style.width = rect.width + 'px';
        portal.style.top = '-9999px';
        portal.style.bottom = '';
        portal.style.maxHeight = '';
        portal.style.overflowY = '';

        var menuHeight = portal.offsetHeight;
        var spaceBelow = window.innerHeight - rect.bottom;
        var spaceAbove = rect.top;

        if (spaceBelow >= menuHeight + 8) {
            portal.style.top = (rect.bottom + 4) + 'px';
        } else if (spaceAbove >= menuHeight + 8) {
            portal.style.top = (rect.top - menuHeight - 4) + 'px';
        } else {
            if (spaceBelow >= spaceAbove) {
                portal.style.top = (rect.bottom + 4) + 'px';
                portal.style.maxHeight = (spaceBelow - 8) + 'px';
                portal.style.overflowY = 'auto';
            } else {
                portal.style.top = '8px';
                portal.style.maxHeight = (spaceAbove - 8) + 'px';
                portal.style.overflowY = 'auto';
            }
        }
        activeBtn = btn;
    }

    function closeDropdown() {
        portal.style.display = 'none';
        portal.style.maxHeight = '';
        portal.style.overflowY = '';
        portal.innerHTML = '';
        activeBtn = null;
    }

    document.querySelectorAll('.download-btn').forEach(function (btn) {
        btn.addEventListener('click', function (e) {
            e.stopPropagation();
            if (activeBtn === btn) { closeDropdown(); } else { openDropdown(btn); }
        });
    });

    document.addEventListener('click', function (e) {
        if (!portal.contains(e.target)) closeDropdown();
    });
    window.addEventListener('scroll', closeDropdown, true);
    window.addEventListener('resize', closeDropdown);

    // ================================================================
    // REVIEW MODAL
    // ================================================================
    var reviewModal   = document.getElementById('reviewModal');
    var modalTitle    = document.getElementById('modalTitle');
    var modalSubtitle = document.getElementById('modalSubtitle');
    var modalList     = document.getElementById('modalQuestionsList');
    var modalFilterType = document.getElementById('modalFilterType');
    var modalFilterDiff = document.getElementById('modalFilterDiff');
    var currentQuestData = null;
    var currentQuestId   = null;

    document.querySelectorAll('.review-btn').forEach(function (btn) {
        btn.addEventListener('click', function () {
            var questId    = btn.getAttribute('data-quest-id');
            var questTitle = btn.getAttribute('data-quest-title');

            currentQuestId = questId;
            modalTitle.textContent    = questTitle;
            modalSubtitle.textContent = 'Select questions to include in your download';

            document.getElementById('modalDownloadDocx').href     = '/questionnaires/download/' + questId + '/?type=generated&format=docx';
            document.getElementById('modalDownloadPdf').href      = '/questionnaires/download/' + questId + '/?type=generated&format=pdf';
            document.getElementById('modalDownloadOriginal').href = '/questionnaires/download/' + questId + '/?type=original';

            reviewModal.classList.remove('hidden');
            reviewModal.classList.add('flex');
            document.body.style.overflow = 'hidden';

            loadQuestions(questId);
        });
    });

    function closeModal() {
        reviewModal.classList.add('hidden');
        reviewModal.classList.remove('flex');
        document.body.style.overflow = '';
        modalList.innerHTML = '';
        currentQuestData = null;
        modalFilterType.innerHTML = '<option value="all">All Types</option>';
        modalFilterDiff.value = 'all';
    }

    document.getElementById('closeReviewModal').addEventListener('click', closeModal);
    document.getElementById('closeReviewModalFooter').addEventListener('click', closeModal);
    reviewModal.addEventListener('click', function (e) { if (e.target === reviewModal) closeModal(); });
    document.addEventListener('keydown', function (e) { if (e.key === 'Escape') closeModal(); });

    function loadQuestions(questId) {
        modalList.innerHTML = '<div class="flex items-center justify-center py-10 text-gray-400">' +
            '<div class="text-center">' +
            '<div style="width:40px;height:40px;border:4px solid #e9d5ff;border-top-color:#a855f7;border-radius:50%;margin:0 auto 12px;animation:spin 1s linear infinite;"></div>' +
            '<p>Loading questions...</p></div></div>';

        fetch('/questionnaires/get-questions/' + questId + '/')
            .then(function (r) { return r.json(); })
            .then(function (data) {
                currentQuestData = data.questions;
                renderQuestions(data.questions);
                buildTypeFilter(data.questions);
                updateModalStats();
            })
            .catch(function () {
                modalList.innerHTML = '<div class="text-center py-10 text-red-500">' +
                    '<i class="bi bi-exclamation-circle text-3xl mb-2 block"></i>' +
                    '<p>Failed to load questions. Please try again.</p></div>';
            });
    }

    function renderQuestions(questions) {
        if (!questions || questions.length === 0) {
            modalList.innerHTML = '<div class="text-center py-10 text-gray-500">' +
                '<i class="bi bi-inbox text-4xl mb-3 block text-gray-300"></i>' +
                '<p>No questions available for this questionnaire.</p></div>';
            return;
        }

        var diffColors = { easy: 'border-green-500', medium: 'border-yellow-500', hard: 'border-red-500' };
        var diffBadge  = { easy: 'bg-green-100 text-green-800', medium: 'bg-yellow-100 text-yellow-800', hard: 'bg-red-100 text-red-800' };

        var html = '';
        questions.forEach(function (q, i) {
            var borderColor = diffColors[q.difficulty] || 'border-gray-300';
            var badgeColor  = diffBadge[q.difficulty]  || 'bg-gray-100 text-gray-700';

            html += '<div class="modal-question-card bg-white rounded-lg border-l-4 ' + borderColor + ' shadow-sm p-4"' +
                ' data-type="' + q.type + '" data-difficulty="' + q.difficulty + '" data-points="' + q.points + '">' +
                '<div class="flex items-start gap-3">' +
                '<input type="checkbox" class="modal-checkbox w-5 h-5 text-purple-600 rounded mt-0.5 cursor-pointer flex-shrink-0"' +
                ' data-question-id="' + q.id + '" checked>' +
                '<div class="flex-1 min-w-0">' +
                '<div class="flex flex-wrap gap-2 mb-2">' +
                '<span class="px-2 py-0.5 bg-blue-100 text-blue-800 text-xs font-semibold rounded-full">' + q.type_display + '</span>' +
                '<span class="px-2 py-0.5 ' + badgeColor + ' text-xs font-semibold rounded-full">' + q.difficulty + '</span>' +
                '<span class="px-2 py-0.5 bg-gray-100 text-gray-700 text-xs font-semibold rounded-full">' + q.points + ' pt</span>' +
                '</div>' +
                '<p class="text-gray-800 font-medium text-sm mb-2">' + (i + 1) + '. ' + escapeHtml(q.question_text) + '</p>';

            if (q.type === 'multiple_choice' && q.options) {
                html += '<div class="grid grid-cols-1 md:grid-cols-2 gap-1.5 ml-2">';
                var letters = ['A', 'B', 'C', 'D'];
                q.options.forEach(function (opt, idx) {
                    var isCorrect = q.correct_answer && q.correct_answer.toUpperCase() === letters[idx];
                    html += '<div class="flex items-center p-1.5 rounded text-xs ' +
                        (isCorrect ? 'bg-green-50 border border-green-400 text-green-800 font-semibold' : 'bg-gray-50 text-gray-700') + '">' +
                        '<span class="font-bold mr-1">' + letters[idx] + '.</span>' + escapeHtml(opt) +
                        (isCorrect ? '<i class="bi bi-check-circle-fill ml-auto text-green-600"></i>' : '') +
                        '</div>';
                });
                html += '</div>';
            } else {
                html += '<div class="bg-green-50 border-l-4 border-green-400 p-2 rounded text-xs mt-1">' +
                    '<span class="text-gray-500">Answer: </span>' +
                    '<span class="text-green-800 font-semibold">' + escapeHtml(q.correct_answer || '') + '</span></div>';
            }

            if (q.explanation) {
                html += '<div class="mt-2 p-2 bg-blue-50 rounded text-xs text-gray-600 border-l-4 border-blue-300">' +
                    '<i class="bi bi-lightbulb-fill text-blue-500 mr-1"></i>' + escapeHtml(q.explanation) + '</div>';
            }

            html += '</div></div></div>';
        });

        modalList.innerHTML = html;

        modalList.querySelectorAll('.modal-checkbox').forEach(function (cb) {
            cb.addEventListener('change', function () {
                updateModalStats();
                updateDownloadLinks();
            });
        });

        updateModalStats();
        updateDownloadLinks();
    }

    function buildTypeFilter(questions) {
        var types = {};
        questions.forEach(function (q) { types[q.type] = q.type_display; });
        var html = '<option value="all">All Types</option>';
        Object.keys(types).forEach(function (key) {
            html += '<option value="' + key + '">' + types[key] + '</option>';
        });
        modalFilterType.innerHTML = html;
    }

    function applyModalFilters() {
        var type = modalFilterType.value;
        var diff = modalFilterDiff.value;

        modalList.querySelectorAll('.modal-question-card').forEach(function (card) {
            var visible = (type === 'all' || card.dataset.type === type) &&
                          (diff === 'all' || card.dataset.difficulty === diff);
            card.style.display = visible ? 'block' : 'none';
            var cb = card.querySelector('.modal-checkbox');
            if (cb) cb.checked = visible;
        });

        updateModalStats();
        updateDownloadLinks();
    }

    modalFilterType.addEventListener('change', applyModalFilters);
    modalFilterDiff.addEventListener('change', applyModalFilters);

    document.getElementById('modalSelectAll').addEventListener('click', function () {
        modalList.querySelectorAll('.modal-question-card').forEach(function (card) {
            if (card.style.display !== 'none') card.querySelector('.modal-checkbox').checked = true;
        });
        updateModalStats();
        updateDownloadLinks();
    });

    document.getElementById('modalDeselectAll').addEventListener('click', function () {
        modalList.querySelectorAll('.modal-checkbox').forEach(function (cb) { cb.checked = false; });
        updateModalStats();
        updateDownloadLinks();
    });

    function updateModalStats() {
        var cards   = modalList.querySelectorAll('.modal-question-card');
        var checked = modalList.querySelectorAll('.modal-checkbox:checked');
        var pts = 0;
        checked.forEach(function (cb) {
            pts += parseInt(cb.closest('.modal-question-card').dataset.points || 1);
        });
        document.getElementById('modalTotalCount').textContent    = cards.length;
        document.getElementById('modalSelectedCount').textContent = checked.length;
        document.getElementById('modalPointsCount').textContent   = pts;
    }

    function updateDownloadLinks() {
        var checked = modalList.querySelectorAll('.modal-checkbox:checked');
        var ids = [];
        checked.forEach(function (cb) { ids.push(cb.getAttribute('data-question-id')); });

        var questId  = currentQuestId;
        var baseDocx = '/questionnaires/download/' + questId + '/?type=generated&format=docx';
        var basePdf  = '/questionnaires/download/' + questId + '/?type=generated&format=pdf';

        if (ids.length > 0) {
            var qs = '&questions=' + ids.join(',');
            document.getElementById('modalDownloadDocx').href = baseDocx + qs;
            document.getElementById('modalDownloadPdf').href  = basePdf + qs;
        } else {
            document.getElementById('modalDownloadDocx').href = '#';
            document.getElementById('modalDownloadPdf').href  = '#';
        }
        document.getElementById('modalDownloadOriginal').href = '/questionnaires/download/' + questId + '/?type=original';

        var bisuBtns = [
            document.getElementById('modalDownloadDocx'),
            document.getElementById('modalDownloadPdf')
        ];
        bisuBtns.forEach(function (btn) {
            if (ids.length === 0) {
                btn.classList.add('opacity-50', 'cursor-not-allowed');
                btn.onclick = function(e) { e.preventDefault(); alert('Please select at least one question first.'); };
            } else {
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
                btn.onclick = null;
            }
        });

        var label = document.getElementById('modalSelectionLabel');
        if (label) {
            label.textContent = ids.length > 0
                ? ids.length + ' question(s) selected for download'
                : 'No questions selected';
        }
    }

    function escapeHtml(str) {
        if (!str) return '';
        return str
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;');
    }

})();
</script>

{% endblock %}